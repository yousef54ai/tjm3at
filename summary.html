<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter Summary</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/summary.css">

    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
</head>
<body>
    <div class="container fade-in">
        <div class="breadcrumb">
            <a href="index.html" id="breadcrumb-home">Home</a>
            <span>/</span>
            <a href="#" id="breadcrumb-class"></a>
            <span>/</span>
            <span id="breadcrumb-summary">Summary</span>
        </div>

        <header class="summary-header">
            <h1 id="chapter-title"></h1>
        </header>

        <div id="summary-content" class="summary-content"></div>

        <div class="action-buttons">
            <button onclick="window.print()" class="nav-btn secondary-btn">üñ®Ô∏è Print Summary</button>
            <button onclick="history.back()" class="nav-btn primary-btn">‚Üê Back to Class</button>
        </div>
    </div>

    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const classId = urlParams.get('class');
        const summaryId = urlParams.get('summary');

        if (!classId || !summaryId) {
            window.location.href = 'index.html';
        }

        // Load class data for breadcrumb
        fetch(`data/classes/${classId}.json`)
            .then(response => response.json())
            .then(classData => {
                document.getElementById('breadcrumb-class').textContent = classData.code;
                document.getElementById('breadcrumb-class').href = `class.html?id=${classId}`;
            });

        // Load summary data
        fetch(`data/summaries/${classId}/${summaryId}.json`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Summary not found');
                }
                return response.json();
            })
            .then(data => {
                // Set language and direction from summary data
                document.documentElement.lang = data.language;
                document.documentElement.dir = data.language === 'ar' ? 'rtl' : 'ltr';

                // Update page title
                document.title = `${data.chapter} - Summary`;
                document.getElementById('chapter-title').textContent = data.chapter;

                // Render summary sections
                const contentDiv = document.getElementById('summary-content');

                data.sections.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'summary-section';

                    const sectionTitle = document.createElement('h2');
                    sectionTitle.className = 'section-title';
                    sectionTitle.textContent = section.title;
                    sectionDiv.appendChild(sectionTitle);

                    const itemsList = document.createElement('div');
                    itemsList.className = 'items-list';

                    section.items.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'summary-item';

                        const labelSpan = document.createElement('div');
                        labelSpan.className = 'item-label';
                        labelSpan.textContent = item.label;
                        itemDiv.appendChild(labelSpan);

                        const formulaDiv = document.createElement('div');
                        formulaDiv.className = 'item-formula';
                        formulaDiv.textContent = item.formula;
                        itemDiv.appendChild(formulaDiv);

                        itemsList.appendChild(itemDiv);
                    });

                    sectionDiv.appendChild(itemsList);
                    contentDiv.appendChild(sectionDiv);
                });

                // Render LaTeX
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([contentDiv]).catch((err) => console.log('MathJax typeset failed: ' + err.message));
                } else {
                    setTimeout(() => {
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            MathJax.typesetPromise([contentDiv]).catch((err) => console.log('MathJax typeset failed: ' + err.message));
                        }
                    }, 1000);
                }

                // Fade in
                document.querySelector('.container').classList.add('loaded');
            })
            .catch(error => {
                console.error('Error loading summary:', error);
                alert('Failed to load summary');
                window.history.back();
            });
    </script>
</body>
</html>
